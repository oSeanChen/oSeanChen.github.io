<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Sean's Blog</title><meta name="author" content="Sean"><meta name="copyright" content="Sean"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#000"><meta name="description"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://oseanchen.github.io/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="sy_aItoBmo7s6Mb8wbh97IV_N4jjnUXRzwBNb4brupA"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查詢的內容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '載入更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Sean\'s Blog',
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2024-10-19 01:32:16'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/profile.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">65</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">12</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-solid fa-user"></i><span> 關於我</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 歸檔</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header" style="background-image: url('/img/7212.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Sean's Blog"><span class="site-name">Sean's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜尋</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa-solid fa-user"></i><span> 關於我</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 歸檔</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Sean's Blog</h1><div id="site-subtitle"><span id="subtitle"></span></div><div id="site_social_icons"><a class="social-icon" href="https://github.com/oSeanChen" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://linkedin.com/in/chien-liang-chen-06a685168" target="_blank" title="Linkedin"><i class="fa-brands fa-linkedin"></i></a><a class="social-icon" href="mailto:abbb123p@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/2024/10/19/%E9%9B%BB%E5%95%86-RESTFul-API-Spring-Security-3-UnitTest/" title="電商 RESTFul API + Spring Security (3) UnitTest"><img class="post-bg" src="https://oskarbogacz.dev/wp-content/uploads/2022/07/spring-logo-16-9-transparent-compressed.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="電商 RESTFul API + Spring Security (3) UnitTest"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/19/%E9%9B%BB%E5%95%86-RESTFul-API-Spring-Security-3-UnitTest/" title="電商 RESTFul API + Spring Security (3) UnitTest">電商 RESTFul API + Spring Security (3) UnitTest</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-18T17:31:02.648Z" title="發表於 2024-10-19 01:31:02">2024-10-19</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a></span></div><div class="content">商品 Service UnitTest這邊針對商品部分 Service 寫一些單元測試，下面先列出預計測試的名稱，主要根據實際方法內會出現判斷的條件去設計，嘗試讓每個 Service 單元測試都 100%。
先注入並且初始化我們需要用到的 Bean，這邊主要測試 ProductService ，所以加上 @InjectMocks 註解，其他應用到的 Dao 都用 @Mock 標住用 mock 產生虛擬元件注入有標住 @InjectMocks 的 ProductService，@BeforeEach 先初始化待會會測試用到的一些物件資料。
1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071@ExtendWith(MockitoExtension.class)public class ProductServiceTest &#123;    @Mock    private P ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/10/19/%E9%9B%BB%E5%95%86-RESTFul-API-Spring-Security-2-%E8%A8%82%E5%96%AE%E5%8A%9F%E8%83%BD/" title="電商 RESTFul API + Spring Security  (2) 訂單功能"><img class="post-bg" src="https://oskarbogacz.dev/wp-content/uploads/2022/07/spring-logo-16-9-transparent-compressed.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="電商 RESTFul API + Spring Security  (2) 訂單功能"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/19/%E9%9B%BB%E5%95%86-RESTFul-API-Spring-Security-2-%E8%A8%82%E5%96%AE%E5%8A%9F%E8%83%BD/" title="電商 RESTFul API + Spring Security  (2) 訂單功能">電商 RESTFul API + Spring Security  (2) 訂單功能</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-18T17:29:02.532Z" title="發表於 2024-10-19 01:29:02">2024-10-19</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a></span></div><div class="content">這篇繼續擴充訂單功能，可以回顧一下先前畫的架構圖，我們要有一張中間的表來記錄購物車內有哪些商品資訊，這部分建立訂單可以想像完成選擇要購買的商品之後送出訂單所產生的資料紀錄。

訂單功能建立order_info 訂單資訊，用來記錄我們整筆訂單的彙整資訊，包含關聯哪位 user, 總金額多少
order_item 訂單項目資訊，用來記錄整筆訂單中各別項目關聯哪個 product (product_id)、購買數量是多少(quantity)、價錢(amount)，從中也可以知道屬於哪筆訂單(order_info_id)。
基本資料建立1234567891011121314151617CREATE TABLE order_info(    id                 INT       NOT NULL PRIMARY KEY AUTO_INCREMENT,    user_id            INT       NOT NULL,    total_amount       DECIMAL(10, 2)  NOT NULL, -- 訂單總花費    created_at   ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2024/10/19/%E9%9B%BB%E5%95%86-RESTFul-API-Spring-Security-1-%E5%95%86%E5%93%81%E5%8A%9F%E8%83%BD/" title="電商 RESTFul API + Spring Security  (1) 商品功能"><img class="post-bg" src="https://oskarbogacz.dev/wp-content/uploads/2022/07/spring-logo-16-9-transparent-compressed.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="電商 RESTFul API + Spring Security  (1) 商品功能"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/19/%E9%9B%BB%E5%95%86-RESTFul-API-Spring-Security-1-%E5%95%86%E5%93%81%E5%8A%9F%E8%83%BD/" title="電商 RESTFul API + Spring Security  (1) 商品功能">電商 RESTFul API + Spring Security  (1) 商品功能</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-18T17:22:28.255Z" title="發表於 2024-10-19 01:22:28">2024-10-19</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a></span></div><div class="content">這系列文章會總結先前包含 JPA 和 Security 的應用，詳細可以回顧 Spring Security (1 ~ 4)，整合成一個小電商專案 side project，針對後端 API 和認證的部分，內容因為前面大量的內容會比較長，大家有興趣的可以好好來了解一下。
資料庫結構如果先回顧前面 Security 部分建構的資料庫結構 UML
會有 users, roles, user_roles 三個表去紀錄關於使用者的資訊，也可以從多對多的關聯中找出使用者的角色權限

現在要來加入電商主要的資料就是商品部分，預計會規畫成下面這樣的關係
需求規格會拆分成兩階段來建構：

products 建構，先建立 products, suppliers 1 : 1 關係
order_info 建構，order_info 記錄總價和購買使用者 id，再由 order_item 分別關聯 products 和 order_info，可以關聯出購物車內容，所有需要購買的商品數量和同品項總金額，也關聯出屬於哪張 order_info

大致清楚架構之後接下來預計會實作的一些功能也列出來：
商品相關

p ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/10/15/Spring-Security-4-JWT-%E9%A9%97%E8%AD%89%E5%8F%8A%E7%B5%90%E5%90%88-FilterChain/" title="Spring Security (4) - JWT 驗證及結合 FilterChain"><img class="post-bg" src="https://imgur.com/Q3FzpsF.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring Security (4) - JWT 驗證及結合 FilterChain"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/15/Spring-Security-4-JWT-%E9%A9%97%E8%AD%89%E5%8F%8A%E7%B5%90%E5%90%88-FilterChain/" title="Spring Security (4) - JWT 驗證及結合 FilterChain">Spring Security (4) - JWT 驗證及結合 FilterChain</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-15T14:38:08.091Z" title="發表於 2024-10-15 22:38:08">2024-10-15</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/Spring-Security/">Spring Security</a></span></div><div class="content">接續上一篇我們已經成功產生 JWT 回傳，所以後續使用者需要攜帶 JWT 至 Header 內然後發送請求到我們後端，我們需要驗證 JWT 是否有效然後決定使用者是否可以進入瀏覽或是使用功能，而這相對應的驗證流程，其實 Spring Security 有一套 FilterChain 的機制可以協助我們，這其中包含我們前面實作的帳號密碼驗證等等都是包含在裡面，那我們需要做的就是把 JWT 的驗證放入 FilterChain 裡面。
解析 Token 取出 Claims把之前拿來產生 Token 的 密鑰( getKey() 產生的) 拿來解析 Token，extractAllClaims() 帶入 token 可以取出其中的 Claims 也就是 Payload 的部分。
因為 Payload 裡面有很多屬性，下面另外抽出各別取 username 使用者名稱, expiration 到期時間等等的方法，方便後續驗證時可以引用
1234567891011121314151617181920212223242526272829303132333435363738394041@Service@ ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2024/10/15/Spring-Security-3-JWT-%E4%BB%8B%E7%B4%B9%E5%8F%8A%E5%B0%8E%E5%85%A5/" title="Spring Security (3) - JWT 介紹及導入"><img class="post-bg" src="https://imgur.com/Q3FzpsF.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring Security (3) - JWT 介紹及導入"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/15/Spring-Security-3-JWT-%E4%BB%8B%E7%B4%B9%E5%8F%8A%E5%B0%8E%E5%85%A5/" title="Spring Security (3) - JWT 介紹及導入">Spring Security (3) - JWT 介紹及導入</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-15T14:33:23.287Z" title="發表於 2024-10-15 22:33:23">2024-10-15</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/Spring-Security/">Spring Security</a></span></div><div class="content">JWTJSON Web Token (JWT)，是一種根據將 JSON 格式資料進行編碼的的開放標準（RFC 7519），用於雙方之間安全將訊息作為 JSON 物件進行傳輸，訊息是經過數位簽章 (Digital Signature) 加密，因此可以被驗證及信任。
目前也成為各大網站之間進行資源獲取時所採用證明身份的訊息格式。
為什麼要用?
授權 (Authorization)：先前提過，授權就是指根據使用者身分給予特定的瀏覽或是存取權限，這也是 JWT 常用的情境，例如使用者登入後，點選特定的功能或區域，發送請求時，需夾帶 JWT，Server 端就可根據該 JWT 所帶的資訊驗證是否可以開放使用該功能。像是單一路口登錄 (Single Sign On) 實作上也是廣泛應用到 JWT 。
訊息交換 (Information Exchange)：JWT 可以透過公鑰&#x2F;私鑰來做簽章，讓我們可知道是誰發送這個 JWT，此外，由於簽章是使用 header 和 payload 計算的，因此可驗證內容是否遭到篡改。

JWT 結構可以透過這個網站來測試產生的 jwt 解開後的內容
htt ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/10/08/Spring-Security-2-%E4%B8%B2%E6%8E%A5%E5%80%8B%E4%BA%BA%E8%B3%87%E6%96%99%E5%BA%AB/" title="Spring Security (2) - 串接個人資料庫"><img class="post-bg" src="https://imgur.com/Q3FzpsF.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring Security (2) - 串接個人資料庫"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/08/Spring-Security-2-%E4%B8%B2%E6%8E%A5%E5%80%8B%E4%BA%BA%E8%B3%87%E6%96%99%E5%BA%AB/" title="Spring Security (2) - 串接個人資料庫">Spring Security (2) - 串接個人資料庫</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-08T14:53:37.586Z" title="發表於 2024-10-08 22:53:37">2024-10-08</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/Spring-Security/">Spring Security</a></span></div><div class="content">實際要來看一下我們要使用個人的使用者資訊資料表要如何串接，因為 Security 提供很多客製化的介面所以需要實作許多特殊的物件就會讓流程蠻複雜的，整體來說可以先有個概念，我們原本需要透過 dao 來和 DB 溝通的部分需要改成 Security 框架的模式，原本可以由 Spring Data JPA 直接取得 User 的物件回傳，但因為 Security 將使用者資訊會封裝成 UserDetails 這個物件來回傳，必須要透過 UserDetailsService 這邊來取得這個物件，所以會想辦法把這些東西去實做出來。
資料庫是串接 MySQL ，相關配置可以參考 Spring Data JPA （1）基礎應用架構 引入相關 Dependency
資料庫架構 Database Schema提供 SQL 給大家參考
123456789101112131415161718192021222324CREATE TABLE users(    id         BIGINT PRIMARY KEY AUTO_INCREMENT,    username   VARCHAR(50)  N ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2024/10/08/Spring-Security-1-%E4%BB%8B%E7%B4%B9%E5%8F%8A%E6%87%89%E7%94%A8/" title="Spring Security (1) - 介紹及應用"><img class="post-bg" src="https://imgur.com/Q3FzpsF.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring Security (1) - 介紹及應用"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/08/Spring-Security-1-%E4%BB%8B%E7%B4%B9%E5%8F%8A%E6%87%89%E7%94%A8/" title="Spring Security (1) - 介紹及應用">Spring Security (1) - 介紹及應用</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-08T14:49:21.516Z" title="發表於 2024-10-08 22:49:21">2024-10-08</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/Spring-Security/">Spring Security</a></span></div><div class="content">相信大家應該作為軟體工程師都知道資訊安全的重要性，如果你寫好一個系統，沒有受到好的資安控管，容易成為駭客下手的目標。特別是許多網頁或應用程式都建立在會員系統的基礎之下，這些資訊對於認證（authentication）與授權（authorization）控管相當重要，認證就相當於帳號登入，對系統表示自己是個合法的使用者。而授權則是系統允許該使用者存取某服務，看到特定頁面或是功能等等，也就是存取 API 許可。Spring Security 就提供了這部分的支援讓我們能夠輕鬆整合到 Spring Boot 專案中。
介紹Spring Security 是 Spring Boot 框架中的提供的一個資訊安全模組，能夠靈活的配置來有效保護 Web 應用程序免受各種安全威脅，主要有下面這些特色:

快速整合：Spring Boot Security 可以通過簡單的配置快速整合到 Spring Boot 應用中。
預設安全性：即使沒有進行任何配置，它也能為應用程序提供基本的安全防護，包括預設的登入頁面和認證方法 ⁠。
靈活配置：開發者可以根據需求自定義安全設置，如用戶認證、授權規則等 ⁠。
角色權 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/10/07/UnitTest-5-Mock-Test/" title="UnitTest(5)- Mock Test"><img class="post-bg" src="https://imgur.com/adxkZKm.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UnitTest(5)- Mock Test"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/07/UnitTest-5-Mock-Test/" title="UnitTest(5)- Mock Test">UnitTest(5)- Mock Test</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-07T15:59:28.000Z" title="發表於 2024-10-07 23:59:28">2024-10-07</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/Unit-Test/">Unit Test</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Java/">Java</a><span class="article-meta-link">•</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Spring-Boot/">Spring Boot</a><span class="article-meta-link">•</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/JUnit-5/">JUnit 5</a><span class="article-meta-link">•</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Mockito/">Mockito</a></span></div><div class="content">接續前一篇進行 Service 的測試，我們接序同一個情境針對 Product 的 CRUD，但是應用不同的寫法， 這邊會運用到 Mockito 這個套件來幫助我們應用 Mock 的虛構物件進行測試。
關於 Mock
顧名思義 Mock 有模擬、假的意思，將這樣模擬概念應用到測試中，就是希望程式原先依賴的對象都可以透過 mock 方式建立一個假的對象去模擬真實行為。
先前介紹單元測試時，有提到特性是應該各單元測試互相獨立，不依賴其他外部系統，Mock Test 是一種單元測試方法，能專注於要測試的程式本身的運作中，避免測試一個方法卻要建構整個 bean 相關的依賴架構。

一個系統架構會有多個類別之間互相依賴，且在 Spring Boot 中會都註冊成為 Bean，如下圖這樣多個 Class 互相依賴，Class A 需要依賴 B 和 C

引入 mock 測試時，就可以創建假的對象類，替換掉真實的 Class B 和 C，並可以自己設定這個 mock 對象的參數和期望結果，讓我們可以專注在測試當前的 Class A 應該要得到的回傳或是要 Pass 的結果，不受其他的外部服務影響，就 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2024/10/07/UnitTest-4-Service-Dao-%E5%B1%A4%E6%B8%AC%E8%A9%A6%E6%92%B0%E5%AF%AB/" title="UnitTest(4)- Service/Dao 層測試撰寫"><img class="post-bg" src="https://imgur.com/adxkZKm.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UnitTest(4)- Service/Dao 層測試撰寫"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/07/UnitTest-4-Service-Dao-%E5%B1%A4%E6%B8%AC%E8%A9%A6%E6%92%B0%E5%AF%AB/" title="UnitTest(4)- Service/Dao 層測試撰寫">UnitTest(4)- Service/Dao 層測試撰寫</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-07T15:58:07.000Z" title="發表於 2024-10-07 23:58:07">2024-10-07</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/Unit-Test/">Unit Test</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Java/">Java</a><span class="article-meta-link">•</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Spring-Boot/">Spring Boot</a><span class="article-meta-link">•</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/JUnit-5/">JUnit 5</a></span></div><div class="content">這一篇我們來針對 Service &#x2F; Dao 層進行測試的撰寫吧，以 MVC 架構下算是 Model 的部分會比較常進行測試程式的撰寫，因為牽涉到主要業務邏輯的運作，所以會比起 Controller 和 View 來說比較常需要進行測試，以 MVC 架構之下我認為個別需要測試的頻率及重點表整理如下




Model(Service&#x2F;Dao)
Controller
View



測試頻率
高
中
低


重點
業務邏輯




數據驗證狀態管理 | 請求&#x2F;錯誤處理驗證rounting 邏輯數據轉換（DTO 轉換） | 數據綁定模板渲染 |
所以這篇來主要針對最高頻率進行測試部分作介紹，Controller 層會應用到的寫法又會不太一樣，之後有機會可以再補充。
單元測試準備簡單建立一個之前介紹 Jpa 關聯時使用的類似欄位架構
db schema and data
12345678910111213CREATE TABLE product (    id BIGINT AUTO_INCREMENT PRIMARY KEY,    name VARCHAR( ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2024/10/06/UnitTest-3-Junit-5-%E5%B8%B8%E7%94%A8%E8%A8%BB%E8%A7%A3/" title="UnitTest(3)- Junit 5 常用註解"><img class="post-bg" src="https://imgur.com/adxkZKm.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UnitTest(3)- Junit 5 常用註解"></a></div><div class="recent-post-info"><a class="article-title" href="/2024/10/06/UnitTest-3-Junit-5-%E5%B8%B8%E7%94%A8%E8%A8%BB%E8%A7%A3/" title="UnitTest(3)- Junit 5 常用註解">UnitTest(3)- Junit 5 常用註解</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">發表於</span><time datetime="2024-10-06T13:58:01.000Z" title="發表於 2024-10-06 21:58:01">2024-10-06</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/">Spring Boot</a><i class="fas fa-angle-right article-meta-link"></i><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring-Boot/Unit-Test/">Unit Test</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Java/">Java</a><span class="article-meta-link">•</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/Spring-Boot/">Spring Boot</a><span class="article-meta-link">•</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/JUnit-5/">JUnit 5</a></span></div><div class="content">Junit 5 常用註解
@Test：標註方法為測試程試
@BeforeEach：每項測試項目開始前都會執行一次
@AfterEach：每項測試項目結束都會執行一次
@BeforeAll：測試開始之前執行一次
@AfterAll：測試結束之後執行一次
@Disabled：不列入測試項目
@DisplayName：測試結果顯示特定名稱

延伸先前計算相關的方法測試，我們補齊加減乘除各種方法跟測試
123456789101112131415161718192021public class Calculator &#123;    public int add(int x, int y) &#123;        return x + y;    &#125;    public int subtract(int x, int y) &#123;        return x - y;    &#125;    public int multiply(int x, int y) &#123;        return x * y;    &#125;    public int div ...</div></div></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/#content-inner">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/#content-inner">7</a><a class="extend next" rel="next" href="/page/2/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/profile.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Sean</div><div class="author-info__description">JAVA 後端工程師，嘗試寫下文章記錄自己的所見所聞。</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">65</div></a><a href="/tags/"><div class="headline">標籤</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分類</div><div class="length-num">12</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/oSeanChen" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://linkedin.com/in/chien-liang-chen-06a685168" target="_blank" title="Linkedin"><i class="fa-brands fa-linkedin"></i></a><a class="social-icon" href="mailto:abbb123p@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/19/%E9%9B%BB%E5%95%86-RESTFul-API-Spring-Security-3-UnitTest/" title="電商 RESTFul API + Spring Security (3) UnitTest">電商 RESTFul API + Spring Security (3) UnitTest</a><time datetime="2024-10-18T17:31:02.648Z" title="發表於 2024-10-19 01:31:02">2024-10-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/19/%E9%9B%BB%E5%95%86-RESTFul-API-Spring-Security-2-%E8%A8%82%E5%96%AE%E5%8A%9F%E8%83%BD/" title="電商 RESTFul API + Spring Security  (2) 訂單功能">電商 RESTFul API + Spring Security  (2) 訂單功能</a><time datetime="2024-10-18T17:29:02.532Z" title="發表於 2024-10-19 01:29:02">2024-10-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/19/%E9%9B%BB%E5%95%86-RESTFul-API-Spring-Security-1-%E5%95%86%E5%93%81%E5%8A%9F%E8%83%BD/" title="電商 RESTFul API + Spring Security  (1) 商品功能">電商 RESTFul API + Spring Security  (1) 商品功能</a><time datetime="2024-10-18T17:22:28.255Z" title="發表於 2024-10-19 01:22:28">2024-10-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/15/Spring-Security-4-JWT-%E9%A9%97%E8%AD%89%E5%8F%8A%E7%B5%90%E5%90%88-FilterChain/" title="Spring Security (4) - JWT 驗證及結合 FilterChain">Spring Security (4) - JWT 驗證及結合 FilterChain</a><time datetime="2024-10-15T14:38:08.091Z" title="發表於 2024-10-15 22:38:08">2024-10-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/15/Spring-Security-3-JWT-%E4%BB%8B%E7%B4%B9%E5%8F%8A%E5%B0%8E%E5%85%A5/" title="Spring Security (3) - JWT 介紹及導入">Spring Security (3) - JWT 介紹及導入</a><time datetime="2024-10-15T14:33:23.287Z" title="發表於 2024-10-15 22:33:23">2024-10-15</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分類</span>
            <a class="card-more-btn" href="/categories/" title="檢視更多">
    <i class="fas fa-angle-right"></i></a>
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Java-%E5%9F%BA%E7%A4%8E/"><span class="card-category-list-name">Java 基礎</span><span class="card-category-list-count">4</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/RabbitMQ/"><span class="card-category-list-name">RabbitMQ</span><span class="card-category-list-count">1</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Rails%E5%9F%BA%E7%A4%8E/"><span class="card-category-list-name">Rails基礎</span><span class="card-category-list-count">10</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Rails%E5%A5%97%E4%BB%B6/"><span class="card-category-list-name">Rails套件</span><span class="card-category-list-count">4</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Ruby%E5%9F%BA%E7%A4%8E/"><span class="card-category-list-name">Ruby基礎</span><span class="card-category-list-count">13</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Spring-Boot/"><span class="card-category-list-name">Spring Boot</span><span class="card-category-list-count">30</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Spring-Boot/Lombok/"><span class="card-category-list-name">Lombok</span><span class="card-category-list-count">1</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Spring-Boot/Spring-Security/"><span class="card-category-list-name">Spring Security</span><span class="card-category-list-count">4</span></a></li></ul></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>標籤</span></div><div class="card-tag-cloud"><a href="/tags/%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88/" style="font-size: 1.1em; color: #999">程式設計</a> <a href="/tags/RESTful/" style="font-size: 1.16em; color: #999b9e">RESTful</a> <a href="/tags/%E9%9B%9C%E6%B9%8A%E6%BC%94%E7%AE%97/" style="font-size: 1.1em; color: #999">雜湊演算</a> <a href="/tags/Maven/" style="font-size: 1.1em; color: #999">Maven</a> <a href="/tags/REST/" style="font-size: 1.16em; color: #999b9e">REST</a> <a href="/tags/%E7%B7%A8%E7%A2%BC/" style="font-size: 1.1em; color: #999">編碼</a> <a href="/tags/JUnit-5/" style="font-size: 1.27em; color: #99a0a9">JUnit 5</a> <a href="/tags/Devise/" style="font-size: 1.21em; color: #999ea4">Devise</a> <a href="/tags/%E5%8A%A0%E5%AF%86/" style="font-size: 1.1em; color: #999">加密</a> <a href="/tags/RabbitMQ/" style="font-size: 1.1em; color: #999">RabbitMQ</a> <a href="/tags/Thymeleaf/" style="font-size: 1.1em; color: #999">Thymeleaf</a> <a href="/tags/Oauth/" style="font-size: 1.16em; color: #999b9e">Oauth</a> <a href="/tags/Ruby/" style="font-size: 1.39em; color: #99a4b4">Ruby</a> <a href="/tags/Design-Pattern/" style="font-size: 1.1em; color: #999">Design Pattern</a> <a href="/tags/%E6%9C%83%E5%93%A1%E7%B3%BB%E7%B5%B1/" style="font-size: 1.21em; color: #999ea4">會員系統</a> <a href="/tags/Omniauth/" style="font-size: 1.16em; color: #999b9e">Omniauth</a> <a href="/tags/github/" style="font-size: 1.16em; color: #999b9e">github</a> <a href="/tags/Java/" style="font-size: 1.5em; color: #99a9bf">Java</a> <a href="/tags/Spring-Boot/" style="font-size: 1.44em; color: #99a7ba">Spring Boot</a> <a href="/tags/ORM/" style="font-size: 1.1em; color: #999">ORM</a> <a href="/tags/Mockito/" style="font-size: 1.1em; color: #999">Mockito</a> <a href="/tags/i18n/" style="font-size: 1.1em; color: #999">i18n</a> <a href="/tags/Rails/" style="font-size: 1.33em; color: #99a2af">Rails</a> <a href="/tags/Message-Queue/" style="font-size: 1.1em; color: #999">Message Queue</a> <a href="/tags/%E7%B6%B2%E8%B7%AF/" style="font-size: 1.1em; color: #999">網路</a> <a href="/tags/Cronjob/" style="font-size: 1.1em; color: #999">Cronjob</a> <a href="/tags/%E5%A5%97%E4%BB%B6/" style="font-size: 1.21em; color: #999ea4">套件</a> <a href="/tags/Spring-Data-Jpa/" style="font-size: 1.27em; color: #99a0a9">Spring Data Jpa</a> <a href="/tags/Database/" style="font-size: 1.1em; color: #999">Database</a> <a href="/tags/google/" style="font-size: 1.16em; color: #999b9e">google</a> <a href="/tags/http-request/" style="font-size: 1.16em; color: #999b9e">http request</a> <a href="/tags/Asynchronous/" style="font-size: 1.1em; color: #999">Asynchronous</a> <a href="/tags/%E7%89%A9%E4%BB%B6%E5%B0%8E%E5%90%91/" style="font-size: 1.1em; color: #999">物件導向</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>歸檔</span><a class="card-more-btn" href="/archives/" title="檢視更多">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><span class="card-archive-list-count">12</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><span class="card-archive-list-count">12</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><span class="card-archive-list-count">2</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/08/"><span class="card-archive-list-date">八月 2023</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">五月 2023</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/04/"><span class="card-archive-list-date">四月 2023</span><span class="card-archive-list-count">2</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>網站資訊</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章數目 :</div><div class="item-count">65</div></div><div class="webinfo-item"><div class="item-name">已執行時間 :</div><div class="item-count" id="runtimeshow" data-publishDate="2022-08-11T16:00:00.000Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站訪客數 :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站總訪問量 :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">最後更新時間 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2024-10-18T17:32:16.828Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/7212.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By Sean</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主題 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="淺色和深色模式轉換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="返回頂部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>window.typedJSFn = {
  init: (str) => {
    window.typed = new Typed('#subtitle', Object.assign({
      strings: str,
      startDelay: 300,
      typeSpeed: 150,
      loop: true,
      backSpeed: 50,
    }, null))
  },
  run: (subtitleType) => {
    if (true) {
      if (typeof Typed === 'function') {
        subtitleType()
      } else {
        getScript('https://cdn.jsdelivr.net/npm/typed.js/dist/typed.umd.min.js').then(subtitleType)
      }
    } else {
      subtitleType()
    }
  }
}
</script><script>function subtitleType () {
  if (true) {
    typedJSFn.init(["程式世界冒險即將開始...","Coding everywhere and thinking everywhere."])
  } else {
    document.getElementById("subtitle").textContent = "程式世界冒險即將開始..."
  }
}
typedJSFn.run(subtitleType)</script><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜尋</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  資料庫載入中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜尋文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>